package id.bisaaja.android.ui.account

import android.app.Activity
import android.app.Dialog
import android.content.Intent
import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Toast
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AppCompatActivity
import androidx.fragment.app.Fragment
import androidx.fragment.app.viewModels
import androidx.lifecycle.lifecycleScope
import androidx.navigation.fragment.findNavController
import dagger.hilt.android.AndroidEntryPoint
import id.bisaaja.android.data.preference.PreferenceHelper
import id.bisaaja.android.databinding.FragmentAddressBinding
import id.bisaaja.android.ui.location.MapsActivity
import id.bisaaja.android.utils.DataState
import id.bisaaja.android.utils.MessageBox
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import javax.inject.Inject

@AndroidEntryPoint
class AddressFragment : Fragment() {

    private var _binding: FragmentAddressBinding? = null
    private val binding get() = _binding!!

    @Inject
    lateinit var preferenceHelper: PreferenceHelper

    private val viewModel: EditProfileViewModel by viewModels()
    private var progressDialog: Dialog? = null
    private val messageBox by lazy { MessageBox(requireContext()) }

    private var userName: String = ""
    private var userEmail: String = ""

    private val mapsLauncher =
        registerForActivityResult(ActivityResultContracts.StartActivityForResult()) { result ->
            if (result.resultCode == Activity.RESULT_OK) {
                val alamat = result.data?.getStringExtra("ADDRESS")
                binding.etAlamat.setText(alamat)
            }
        }


    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = FragmentAddressBinding.inflate(inflater, container, false)
        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        val toolbar = binding.topAppBar
        (activity as? AppCompatActivity)?.apply {
            setSupportActionBar(toolbar)
            supportActionBar?.setDisplayHomeAsUpEnabled(true)
        }

        toolbar.setNavigationOnClickListener {
            findNavController().navigateUp()
        }

        // Load user data
        lifecycleScope.launch {
            val user = withContext(Dispatchers.IO) {
                preferenceHelper.getUserData()
            }

            user?.let {
                userName = it.name
                userEmail = it.email
                withContext(Dispatchers.Main) {
                    binding.etAlamat.setText(it.address)
                }
            }
        }

        arguments?.getString("ADDRESS")?.let {
            binding.etAlamat.setText(it)
        }

        binding.btnPilihAddressMelaluiMaps.setOnClickListener {
            val intent = Intent(requireContext(), MapsActivity::class.java)
            mapsLauncher.launch(intent)
        }

        val alamatKembali = arguments?.getString("ADDRESS")
        if (!alamatKembali.isNullOrEmpty()) {
            binding.etAlamat.setText(alamatKembali)
        }

        binding.btnSaveAddress.setOnClickListener {
            val address = binding.etAlamat.text.toString()
            viewModel.updateProfile(
                name = userName,
                email = userEmail,
                address = address
            )
        }

        // Handle update result
        lifecycleScope.launch {
            viewModel.updateResult.collect { state ->
                when (state) {
                    is DataState.Loading -> {
                        progressDialog = messageBox.getProgressDialog("Menyimpan alamat...")
                        progressDialog?.show()
                    }
                    is DataState.Success -> {
                        progressDialog?.dismiss()
                        Toast.makeText(requireContext(), "Alamat berhasil diperbarui", Toast.LENGTH_SHORT).show()
                    }
                    is DataState.Error -> {
                        progressDialog?.dismiss()
                        Toast.makeText(requireContext(), "Gagal menyimpan: ${state.exception.message}", Toast.LENGTH_SHORT).show()
                    }
                    else -> progressDialog?.dismiss()
                }
            }
        }
    }
    fun setAddress(address: String) {
        binding.etAlamat.setText(address)
    }

    override fun onDestroyView() {
        super.onDestroyView()
        _binding = null
    }
}
